#!/bin/bash

# STAGE A
# CHECK POSITIONAL PARAMETERS
[[ -z "$@" ]] && print_inf 4 && return 1

echo "============================================================================"
echo -e "[\e[32m*\e[0m] \e[34mInitializing\e[0m"
# ALL ESSENTIAL VARIABLES FOR THE DOWNLOAD AND AUTHENTICATION PROCESS
source "${CWORKDIR}/etc/gentoo.conf" >/dev/null 2>&1 \
&& echo -e "[\e[32m*\e[0m] \e[35mExporting variables\e[0m" \
&& echo "============================================================================" \
|| { echo -e "[\e[31m*\e[0m] \e[35mExporting variables\e[0m"; echo -e "[\e[31mAborting\e[0m..."; sleep 2; return 1; }

part_a_f() {
# CALL CATALYST BUILD OR PRECOMPILED BUILD
case "$2" in
	catalyst)
		# PART A FUNDAMENTALS
		if [[ -n $(echo "$@" | grep '\--lawful-good') && -n $(echo "$@" | grep 'gfund') ]]; then
			:
		else
			fundamentals_f "${CDISTDIR}/workdir-catalyst" "$@"
		fi

		if [[ -n $(echo "$@" | grep 'seed') ]]; then
			fetch_new_f "$@" || die "FAILED"
		fi
		
		if [[ "$(awk -F '=' '/CATALYST/{ print $2 }' <"${CLOCALLG}/sinprog")" == 0 ]]; then
			calling_catalyst_f "$@" || die
		else
			if [[ -n $(echo "$@" | grep '\--lawful-good') && -n $(echo "$@" | grep 'gcat') ]]; then
				:
			else
				if repeat_sub_part_f "Catalyst" "configured"; then
					calling_catalyst_f "$@" || die
				else	
					echo -e "\e[33mProceeding with extraction...\e[0m"
				fi
			fi
		fi

		
		if [[ "$(awk -F '=' '/EXTRACTION/{ print $2 }' <"${CLOCALLG}/sinprog")" == 0 ]]; then
			catalyst_extr_tar_f "$@" && RPSRVAR=0 || die
		else
			if [[ -n $(echo "$@" | grep '\--lawful-good') && -n $(echo "$@" | grep 'gextr') ]]; then
				:
			else
				if repeat_sub_part_f "Extraction" "completed"; then
					catalyst_extr_tar_f "$@" && RPSRVAR=0 || die
				else
					echo -e "\e[33mProceeding to Part: B...\e[0m"
				fi
			fi
		fi

		if [[ "$RPSRVAR" == 0 || "$RPSRVAR" == 9 ]]; then
			export BWORKDIR="${CDISTDIR}/workdir-catalyst" \
			&& PARTBCOND="0"
		fi
		unset CATDIR
		unset TARGETNAME
		unset TARGETPATH
		unset TARGETSTAMP
		;;
	precomp)
		# PART A FUNDAMENTALS
		fundamentals_f "${CDISTDIR}/workdir-precomp" "$@"
		if [[ -n $(echo "$@" | grep 'seed') ]]; then
			fetch_new_f "$@" || die "Failed"
		fi
		if [[ "$(awk -F '=' '/PRECOMP/{ print $2 }' <"${CLOCALLG}/sinprog")" == 0 ]]; then
			check_dir_f "${CDISTDIR}/dists/stage3-${ARCH}-latest.tar.bz2" \
			"${CDISTDIR}/workdir-precomp" "$@" && RPSRVAR=0 || die
		else
			if [[ -n $(echo "$@" | grep '\--lawful-good') && -n $(echo "$@" | grep 'gprec') ]]; then
				:
			else
				if repeat_sub_part_f "Precomp Extraction" "completed"; then
					check_dir_f
					"${CDISTDIR}/dists/stage3-${ARCH}-latest.tar.bz2" \
					"${CDISTDIR}/workdir-precomp" "$@" && RPSRVAR=0
				else
					die
				fi
			fi
		fi

		if [[ "$RPSRVAR" == 0 || "$RPSRVAR" == 9 ]]; then
			export BWORKDIR="${CDISTDIR}/workdir-precomp" \
			&& PARTBCOND="0" \
			&& sinit_mon_f "PRECOMP"
		fi;;
esac
}

echo $@
if [[ -n $(echo "$@" | grep '\--force-new') ]]; then
	part_a_f "$@"
else
	if [[ -n $(echo "$@" | grep '\--lawful-good') && -n $(echo "$@" | grep 'gparta') ]]; then
		:
	else
		if [[ "$(awk -F '=' '/PARTA/{ print $2 }' <"${CLOCALLG}/sinprog")" == 1 ]]; then
			repeat_part_f "A" && part_a_f "$@"
			
			if [[ "$RPPVAR" == 9 ]]; then
				if [[ -n $(echo "$@" | grep 'catalyst') ]]; then
					export BWORKDIR="${CDISTDIR}/workdir-catalyst" \
					&& PARTBCOND="0"
				elif [[ -n $(echo "$@" | grep 'precomp') ]]; then
					export BWORKDIR="${CDISTDIR}/workdir-precomp" \
					&& PARTBCOND="0"
				fi
			else
				echo -e "\e[31mNo workdir defined. Wont proceed!\e[0m"
				die "$@"
			fi
		else
			part_a_f "$@"
		fi
	fi
fi

[[ "${PARTBCOND}" != 0 ]] && echo -e "\e[31mNo workdir defined. Wont proceed!\e[0m" \
&& echo "$@" && exit 1
echo
echo "============================================================================"
echo -e "\e[35mPART:B Preparing to enter the new system\e[0m"
echo "============================================================================"

amiroot "$UID" && echo -e "[\e[32m*\e[0m] Requesting root privileges" \
|| { echo -e "[\e[31m*\e[0m] Requesting root privileges"; exit 1; }

TARGETSTAMP="$(grep 'version_stamp' "${CCONFDIR}/system/catalyst/stage3.spec" \
| sed '/^#/ d' | awk -F ' ' '{ print $2 }' | sed  -e "s_\"__g")"\
&& if pr_chroot_f "${BWORKDIR}" "$@"; then
	SUBBUILD=0
	GSEVER="${GSEVER}.${SUBBUILD}"
	while true; do
		if ! ls "${CDISTDIR}/stage3-amd64-${GSEVER}.tar.bz2" >/dev/null 2>&1; then
			echo -e "\e[34mArchiving...\e[0m"
			tar cvf "${CDISTDIR}/stage3-amd64-${GSEVER}.tar.bz2" -C "${BWORKDIR}" >/dev/null 2>&1 \
			&& { print_inf 1 && echo -e "\e[34mYou can find your system @ ${CDISTDIR}\e[0m"
			echo -e "\e[34mWith version extension: ${GSEVER}\e[0m"; } \
			|| die "Failed"
			break
		else
			((++SUBBUILD))
		fi
	done
else
	exit 1
fi

exit

gpg --armor --export email > "${FINALDIST}/key.asc" # THIS WILL BE ADDED TO THE HOSTS
gpg --detach-sign -o ${GSE_VER}.gpg "${FINALDIST}/${IMAGE}"
#rm -rf "$1/sinit.d"
unset CATDIR
unset TARGETPATH
unset TARGETSTAMP