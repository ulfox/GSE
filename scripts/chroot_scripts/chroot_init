#!/bin/bash

#
# THE MAIN CHROOT SCRIPT.
# ALL CONFIGURATIONS HAPPEN HERE OR ARE SOURCED FROM HERE
# PLEASE DO NOT MODIFY THIS FILE, BUT REFEREE AT CONFIGURATION SUBMENU
# IF YOU NEED TO ADD EXTRA FEATURES TO YOUR SYSTEM.
# 

LC_COLLATE="C"
LC_ALL="en_US.UTF-8"
LC_CTYPE="en_US.UTF-8"

source /etc/profile && export PS1="( 'Part C: Preparing to bootstrap' ) $PS1"
export CHDIR="/sinit.d"
export PATH=${PATH}:${CHDIR}
source "${CHDIR}/chinit.conf" \
&& source "${CHDIR}/cfunctions" && source "${CHDIR}/coptions"|| die "Failed"
[[ ! -e "${CHDIR}/emergeresume" ]] && echo "#####" >> "${CHDIR}/emergeresume" \
|| sed -i "/#####/d" "${CHDIR}/emergeresume"

# PART C BEGINS
if [[ -n $(echo "$@" | grep '\--force-new') ]]; then
	part_c_f "$@" || die
else
	if [[ "$(awk -F '=' '/UPDATE/{ print $2 }' <"${CHDIR}/chsinprog")" == 0 ]]; then
		part_c_f "$@" || die
	else
		if repeat_part_f "Portage Update"; then
			part_c_f "$@" || die
		fi
	fi
fi

# PART PORTAGE, PROFILE AND FEATURES UPDATE
if [[ -n $(echo "$@" | grep '\--force-new') ]]; then
	part_portage_f "$@" && chsinit_mon_f "PORTAGE"
else
	if [[ "$(awk -F '=' '/UPDATE/{ print $2 }' <"${CHDIR}/chsinprog")" == 0 ]]; then
		part_portage_f "$@" && chsinit_mon_f "PORTAGE"
	else
		if repeat_part_f "Portage Configuration"; then
			part_portage_f "$@" && chsinit_mon_f "PORTAGE"
		fi
	fi
fi

# APPLY NEW CHANGES
apply_new_f "UDN"

if [[ -n $(echo "$@" | grep '\--force-new') ]]; then
	:
else
	if [[ -n $(echo "$@" | grep 'precomp') ]]; then
		# Part D Begins
		if [[ "$(awk -F '=' '/REBUILD/{ print $2 }' <"${CHDIR}/chsinprog")" == 0 ]]; then
			echo -e "\e[35mPart D: Rebuilding system\e[0m"
			env-update > /dev/null 2>&1 && source /etc/profile && export PS1="( 'Part D: Rebuilding system' ) $PS1"
			export PATH=${PATH}:${CHDIR}
			emerge_rebuild_system_f
			chsinit_mon_f "REBUILD"
		fi
	fi
fi

# PART E BEGINS
if [[ -n $(echo "$@" | grep '\--force-new') ]]; then
	configure_system_f
else
	if [[ "$(awk -F '=' '/CONFIGURE/{ print $2 }' <"${CHDIR}/chsinprog")" == 0 ]]; then
		configure_system_f
	else
		if repeat_part_f "System Configuration"; then
			configure_system_f
		fi
	fi
fi

# PART F BEGINS
if [[ -n $(echo "$@" | grep '\--force-new') ]]; then
	inst_req_f
else
	if [[ "$(awk -F '=' '/INSTALL/{ print $2 }' <"${CHDIR}/chsinprog")" == 0 ]]; then
		inst_req_f
	else
		if repeat_part_f "Installing Packages"; then
			inst_req_f
		fi
	fi
	unset YN
fi

# PART G BEGINS
if [[ -n $(echo "$@" | grep '\--force-new') ]]; then
	runlevel_f
else
	if [[ "$(awk -F '=' '/RUNLEVEL/{ print $2 }' <"${CHDIR}/chsinprog")" == 0 ]]; then
		runlevel_f
	else
		if repeat_part_f "Runlevel Configuration"; then
			runlevel_f
		fi
	fi
	unset YN
fi

# PART H BEGINS
if [[ -n $(echo "$@" | grep '\--force-new') ]]; then
	echo -e "The \e[34mBuilding kernel\e[0m"
	genkernel --install kernel --menuconfig --kernel-config="${CHDIR}/kernel-conf" \
	--makeopts="-j${MKPS}" --btrfs --postclear --e2fsprogs
	echo -e "The \e[34mkernel\e[0m built was \e[32msuccessful\e[0m"
	chsinit_mon_f "KERNEL"
else
	if [[ "$(awk -F '=' '/KERNEL/{ print $2 }' <"${CHDIR}/chsinprog")" == 0 ]]; then
		kernel_conf_f
	else
		if repeat_part_f "Kernel Configuration"; then
			kernel_conf_f
		fi
	fi
	unset YN
fi

# PART I BEGINS
if [[ -n $(echo "$@" | grep '\--force-new') ]]; then
	initramfs_f
else
	if [[ "$(awk -F '=' '/INITRAMFS/{ print $2 }' <"${CHDIR}/chsinprog")" == 0 ]]; then
		initramfs_f
	else
		if repeat_part_f "Initramfs Configuration"; then
			initramfs_f
		fi
	fi
	unset YN
fi

#emerge --deselect gentoo-sources
#rm -rf /var/tmp
#eclean-dist -d
#rm -rf /usr/src/linux-4.9.16-gentoo
#rm -rf /usr/src/linux
#rm -rf issues.info

# Creating user-data dir-tree
mkdir -p /user-data/persistent/{etc,var,logs,config.d,local,rmount}
mkdir -p /user-data/persistent/local/{data,home,root,mnt,media}
mkdir -p /user-data/tmpfs/{tmp,etc,run,opt,var}
