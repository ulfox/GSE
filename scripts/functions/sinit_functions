#!/bin/bash

# CALL SUBSHELL
subshel_f() {
	echo -e "\e[33mCalling bash subshell\e[0m"
	sleep 2
	echo 'echo -e "\e[33mInside Subshell\e[0m"' >> /root/.bashrc
	echo 'echo -e "\e[33mExit to return back to parent\e[0m"' >> /root/.bashrc
	(clear; exec /bin/bash;)
	sed -i "/Inside Subshell/d" "/root/.bashrc"
	sed -i "/Exit to return back to parent/d" "/root/.bashrc"
	echo -e "\e[33mYou are back to parent\e[0m"
}

repeat_part_f() {
while true; do
	echo -e "\e[33mPart $1: Has been completed\e[0m"
	read -rp "Run again? Y/N: " YN
	case "${YN}" in
		[yN])
			return 0;;
		[nN])
			return 9;;
	esac
done
}


calling_catalyst_f(){
	echo -e "\e[34mCalling catalyst\e[0m"
	source "${CWORKDIR}/scripts/functions/init_stage3_seq" "$@" \
	&& sinit_mon_f "CATALYST" || { print_inf_f 2 && exit; }
}

catalyst_extr_tar_f() {
	CATDIR=$(grep storedir "${CCONFDIR}/system/catalyst/catalyst.conf" \
	| sed '/^#/ d' | awk -F '=' '{ print $2 }' | sed  -e "s_\"__g") \
	&& SNAPSHOTNAME="$(grep 'snapshot:' "${CCONFDIR}/system/catalyst/stage1.spec" \
	| sed '/^#/ d' | sed '/^\s*$/d' | awk -F ' ' '{ print $2 }' | sed  -e "s_\"__g")" \
	&& TARGETPATH="$(grep 'source_subpath' "${CCONFDIR}/system/catalyst/stage3.spec" \
	| sed '/^#/ d' | awk -F ' ' '{ print $2 }' | sed  -e "s_\"__g" | awk -F '/' '{ print $1 }')" \
	&& TARGETSTAMP="$(grep 'version_stamp' "${CCONFDIR}/system/catalyst/stage3.spec" \
	| sed '/^#/ d' | awk -F ' ' '{ print $2 }' | sed  -e "s_\"__g")" \
	&& check_dir_f "${CATDIR}/builds/${TARGETPATH}/stage3-${ARCH}-${TARGETSTAMP}.tar.bz2" \
	"${CDISTDIR}/workdir-catalyst" \
	"${CATDIR}/snapshots/portage-${SNAPSHOTNAME}.tar.bz2" \
	&& sinit_mon_f "EXTRACTION"
}

repeat_sub_part_f() {
while true; do
	echo -e "\e[33m$1: Has been $2\e[0m"
	read -rp "Run again? Y/N: " YN
	case "${YN}" in
		[yN])
			return 0;;
		[nN])
			return 9;;
	esac
done
}

sinit_mon_f() {
# PROCESS FLOW TWEAKER DURING ALL BUT CHROOT STAGE. DO NOT EDIT THIS FILE!
case "$1" in
	EXTRACTION)
		sed -i -e 's/EXTRACTION=0/EXTRACTION=1/g' "${CLOCALLG}/sinprog"
		sed -i -e 's/PARTA=0/PARTA=1/g' "${CLOCALLG}/sinprog";;
	RESET)
		sed -i -e 's/1/0/g' "${CLOCALLG}/sinprog";;
	PARTA)
		sed -i -e 's/PARTA=0/PARTA=1/g' "${CLOCALLG}/sinprog";;
	PARTB)
		sed -i -e 's/PARTB=0/PARTA=1/g' "${CLOCALLG}/sinprog";;
	CATALYST)
		sed -i -e 's/CATALYST=0/CATALYST=1/g' "${CLOCALLG}/sinprog";;
	PRECOMP)
		sed -i -e 's/PRECOMP=0/PRECOMP=1/g' "${CLOCALLG}/sinprog"
		sed -i -e 's/PARTA=0/PARTA=1/g' "${CLOCALLG}/sinprog";;
	RDEP)
		sed -i -e 's/RDEP=0/RDEP=1/g' "${CLOCALLG}/sinprog";;
	dn)
		;;
esac
}

# RDEP CHECK
dep_c_f() {
	if [[ "${CREL}" == "Gentoo" ]]; then
		echo -e "\e[33mHost system:\e[0m \e[35m${CREL}\e[0m"
		echo -e "\e[33mBefore you begin, it is strongly recommended to make a\e[0m \e[35mruntime dependency\e[0m \e[33mcheck on the host machine\e[0m"
		echo -e "\e[33mThis check is a simple\e[0m \e[35meix\e[0m \e[33m--installed foo check, which will be very fast and also verify\e[0m"
		echo -e "\e[33mthat during the process, nothing unexpected will occur\e[0m"
		echo -e "\e[33mIf\e[0m \e[35meix\e[0m \e[33mis not installed, do no worry, it will get installed\e[0m"
		echo
		while true; do
			read -rp "Check dependencies? Y/N: " YN
			case "${YN:-n}" in
				[yY])
					echo -e "\e[34mChecking for dependencies\e[0m"
					lcreq_f 1 || exit 1
					sinit_mon_f "RDEP"
					break;;
				[nN])
					echo "If you have not run a dependency check before, please abort"
					for i in {1..0}; do
   						sleep 1
   						printf "\r $i"
					done
					break;;
			esac
		done
		unset YN
	else
		echo -e "\e[33mHost system:\e[0m \e[33m${CREL}\e[0m"
		echo -e "\e[33mBefore you begin, it is strongly recommended to make a\e[0m \e[35mruntime dependency\e[0m \e[33mcheck on the host machine\e[0m"
		echo -e "\e[33mIf the all runtime dependencies are located, the process will continue, otherwise this window will exit. and expect you to manually install them\e[0m"
		echo -e "\e[33mSince only Gentoo is officially upported, it is expected to manually install any missing dependencies\e[0m"
		while true; do
			read -rp "Check dependencies? Y/N: " YN
			case "${YN:-n}" in
				[yY])
					echo -e "\e[34mChecking for dependencies\e[0m"
					lcreq_f 2 || exit 1
					break;;
				[nN])
					echo "If you have not run a dependency check before, please abort"
					for i in {1..0}; do
   						sleep 1
   						printf "\r $i"
					done
					break;;
			esac
		done
	fi
unset YN
}

check_pds_f(){
	[[ -n "$(grep "dist.d/workdir-" "/proc/mounts" | awk -F ' ' '{ print $2 }')" ]] \
	&& while true; do
		while read -r i; do
			umount -l "$i"/* >/dev/null 2>&1 >/dev/null 2>&1
			umount -l "$i" >/dev/null 2>&1 >/dev/null 2>&1
		done < <(grep 'dist.d/workdir-' "/proc/mounts" | awk -F ' ' '{ print $2 }')
		
		[[ -z $(grep "dist.d/workdir-" "/proc/mounts" | awk -F ' ' '{ print $2 }') ]] \
		&& break
	done

	if [[ -n "$@" && -z "$(cat /proc/mounts | grep "workdir-$2")" ]]; then
		rm -rf "$1"
	else
		print_inf_f 3
		exit 1
	fi
}

fundamentals_f() {
	# CHECK FOR RUNTIME DEPENDENCIES
	if [[ "$(awk -F '=' '/RDEP/{ print $2 }' <"${CLOCALLG}/sinprog")" == 0 ]]; then
		dep_c_f
	fi
	
	# CHECK IF THERE IS ANY WORK DONE
	if [[ -n $(echo "$@" | grep '\--force-new') || -n $(echo "$@" | grep '\-fn') ]]; then
		start_new_f "force_new" "$1"
	else
		if [[ "$(awk -F '=' '/PARTA/{ print $2 }' <"${CLOCALLG}/sinprog")" == 1 ]]; then
			start_new_f "ask_new" "$1"
		fi
	fi
	
	clear
	echo "============================================================================"
	echo -e "\e[35mPART:A Fundamentals\e[0m"
	echo "============================================================================"
}

start_new_f() {
	# PROMPT TO CONTINUE OR START ANEW
	if [[ "$1" == "ask_new" ]]; then
		while true; do
			clear; echo -e "\e[33mDo you want to continue from last time?\e[0m"
			echo -e "\e[33mIf you choose\e[0m \e[31mSTART NEW\e[0m\e[33m, workdir will be\e[0m \e[31mpurged\e[0m"
			echo -e "\e[33mAnswer Yes or START NEW: \e[0m"
			read -p "Input :: <= " YN
			echo 
			case "${YN:-n}" in
				[Yy][eE][sS]|[yY])
					break;;
				"START NEW")
					echo -e "\e[31mPurging...\e[0m" 
					check_pds_f "$2" \
					&& sinit_mon_f "RESET" && sed -i -e 's/1/0/g' "${CWORKDIR}/scripts/chroot_scripts/chsinprog"; break;;
				* ) echo "Wrong answer";;
			esac
		done
elif [[ "$1" == "force_new" ]]; then
	echo -e "\e[31mStart new parameter detected\e[0m"
	echo -e "\e[34mIf you select yes, workdir will be purged\e[0m"
	echo -e "\e[34mDo you wish to use this option\e[0m"
	echo "Answer: Y/N "
	while true; do
		read -p "Give input :: <= " YN
		case "${YN:-n}" in
			[Yy][eE][sS]|[yY])
				echo -e "\e[31mPurging...\e[0m" 
				check_pds_f "$2" \
				&& sinit_mon_f "RESET" && sed -i -e 's/1/0/g' "${CWORKDIR}/scripts/chroot_scripts/chsinprog"
				break;;
			[nN][oO]|[nN])
				echo -e "\e[34mExiting...\e[0m"
				exit 1;;
			* ) echo "Wrong answer";;
		esac
	done
fi
unset YN
}

export_dist_f() {
	export GENTOOKEY="$(lynx -dump ${SIGNING_KEY} |  grep "(4096-bit RSA)" | head -1 | awk -F '(' '{ print $1}')"
	export "GENTOOKEY"
	export GENTOOLATEST="$DIST/$(wget -q -O- "${DIST}/latest-stage3-$ARCH.txt" | tail -n 1 | awk -F ' ' '{ print $1 }')"
	export STAGE3TB=$(wget -q -O- "${DIST}/latest-stage3-$ARCH.txt" | tail -n 1 | awk -F ' ' '{ print $1 }' | awk -F '/' '{ print $2 }')
	export GENTOOLATESTASC="$DIST/$(wget -q -O- "${DIST}/latest-stage3-$ARCH.txt" | tail -n 1 | awk -F ' ' '{ print $1 }').DIGESTS.asc"
}

extract_tarball_f() {
	[[ -z "$@" && -d "$2" ]] && print_inf 4 && return 1
	mkdir -p "$2"

	echo -e "\e[34mExtracting tarball\e[0m"
	tar xvjpf "$1" -C "$2" --xattrs --numeric-owner >/dev/null 2>&1 \
	&& echo -e "[\e[32m*\e[0m] Extracted" \
	|| echo -e "[\e[31m*\e[0m] AN ERROR OCCURRED" \
	&& [[ -n "$3" ]] \
	&& { echo -e "\e[34mExtracting portage\e[0m" \
	&& tar xvjpf "$3" --xattrs --numeric-owner -C "$2/usr/" >/dev/null 2>&1 \
	&& echo -e "[\e[32m*\e[0m] Extracted" \
	|| echo -e "[\e[31m*\e[0m] AN ERROR OCCURRED"; }
}

check_dir_f() {
	[[ -z "$@" && -d "$2" ]] && print_inf 4 && return 1
	if [[ -d "$2" ]]; then
		while true; do
			echo -e "Seems that there already has been done some work at the \e[34mbuilderdir\e[0m"
			echo "You could either continue from where you left, or backup/purge then start anew"
			echo -e "Give one of: \e[32mCONTINUE\e[0m/\e[34mOLD\e[0m/\e[31mPURGE\e[0m "
			read -rp "Input :: <= " ANS
			case $ANS in
				OLD)
					echo "Backing up..."
					mv "$2" "$2.old"
					extract_tarball_f "$@"
					break;;
				PURGE)
					echo "This may take some time"
					echo "Purging..."
					check_pds_f "$2"
					extract_tarball_f "$@"
					break;;
				CONTINUE)
					break;;
			esac
		done
	else
		extract_tarball_f "$@"
	fi
}

amiroot() {
	if [[ "$1" != "0" ]]
	then
		echo -e "\e[31mThis operation requires root privileges\e[0m"
		echo "Returning back..."
		sleep 2
		BACKTO="MM"
		return 1
	fi
	return 0
}

gentoo_key_f() {
	[[ -z "${GENTOOKEY}" ]] && print_inf_f 4 && return 1
	gpg --keyserver hkps.pool.sks-keyservers.net --recv-keys >/dev/null 2>&1 ${GENTOOKEY} \
	&& echo -e "[\e[32m*\e[0m]\e[32m Fetching Key\e[0m" \
	|| { echo -e "[\e[31m*\e[0m]\e[31m Fetching Key\e[0m"; return 1; }
}

get_latest_f() {
	[[ -z "${GENTOOLATEST}" || -z "${GENTOOLATESTASC}" ]] && print_inf_f 4 && return 1
	mkdir -p "${CDISTDIR}/dists" \
	&& echo -e "[\e[32m*\e[0m] Getting \e[34m${STAGE3TB}\e[0m"
	wget -c -O "${CDISTDIR}/dists/stage3-${ARCH}-latest.tar.bz2" "${GENTOOLATEST}" \
	&& echo "${STAGE3TB}" > "${CDISTDIR}/dists/latest.info" \
	&& print_inf_f 1 || { print_inf_f 2; return 1; }

	wget -c -O "${CDISTDIR}/dists/stage3-${ARCH}-latest.tar.bz2.DIGESTS.asc" "${GENTOOLATESTASC}" >/dev/null 2>&1 \
	&& echo -e "[\e[32m*\e[0m] Getting \e[34m${GENTOOLATEST}\e[0m" \
	|| { echo -e "[\e[31m*\e[0m] \e[31mFAILD\e[0m: Getting \e[34m${GENTOOLATEST}\e[0m"; exit 1; }

	wget -c -O "${CDISTDIR}/dists/stage3-${ARCH}-latest.tar.bz2.DIGESTS" "${GENTOOLATEST}.DIGESTS" >/dev/null 2>&1 \
	&& echo -e "[\e[32m*\e[0m] Getting \e[34m${GENTOOLATEST}.DIGESTS\e[0m" \
	|| { echo -e "[\e[31m*\e[0m] \e[31mFAILD\e[0m: Getting $\e[34m${GENTOOLATEST}.DIGESTS\e[0m"; exit 1; }
}

verify_download_f() {
	gpg --verify "${CDISTDIR}/dists/stage3-${ARCH}-latest.tar.bz2.DIGESTS.asc" >/dev/null 2>&1 \
	&& echo -e "[\e[32m*\e[0m] Verifying \e[35mcryptographic signature\e[0m" \
	|| { echo -e "[\e[31m*\e[0m] \e[31mFAILD\e[0m: Verifying \e[31mcryptographic signature\e[0m"; exit 1; }

	[[ $(grep -A 1 -i sha512 "${CDISTDIR}/dists/stage3-${ARCH}-latest.tar.bz2.DIGESTS.asc" | head -n 2 | grep stage3 | awk -F ' ' '{ print $1 }') \
	== $(sha512sum "${CDISTDIR}/dists/stage3-${ARCH}-latest.tar.bz2" |  awk -F ' ' '{ print $1 }') ]] \
	&& echo -e "[\e[32m*\e[0m] Verifying \e[35msha512sums\e[0m" \
	|| { echo -e "[\e[31m*\e[0m] \e[31mFAILD\e[0m: Verifying \e[31msha512sums\e[0m"; exit 1; }
}

fetch_new_f() {
	# CHECK FOR THE POSITIONAL PARAMETERS AND BAILOUT IF THEY ARE MISSING
	[[ -z "$@" ]] && print_inf_f 4 && exit 1
	echo -e "\e[34mSearching for tarball...\e[0m"
	if [[ -n $(echo "$@" | grep '\--fetch-new') || -n $(echo "$@" | grep '\-fn') ]]; then
		rm -f "${CDISTDIR}/dists/stage3-${ARCH}-latest.tar.bz2" >/dev/null 2>&1
		rm -f "${CDISTDIR}/dists/stage3-${ARCH}-latest.tar.bz2.DIGESTS.asc" >/dev/null 2>&1
		rm -f "${CDISTDIR}/dists/stage3-${ARCH}-latest.tar.bz2.DIGESTS" >/dev/null 2>&1
		export_dist_f
		# FETCH THE KEYS FOR THE CRYPTOGRAPHIC AUTHENTICATION
		gentoo_key_f
		# GET LATEST STAGE3 TARBALL, .DIGEST && .DIGEST.asc
		get_latest_f
		# VERIFY THE AUTHENTICATION OF THE DOWNLOADED FILES
		verify_download_f
	else
		export_dist_f
		# GET LATEST STAGE3 TARBALL, .DIGEST && .DIGEST.asc
		local_stage3="$(cat "${CDISTDIR}/dists/latest.info")"
		if [[ "${local_stage3}" == "${STAGE3TB}" ]]; then
			echo -e "[\e[32m*\e[0m] Latest stage3 is already present locally"
		else
			# FETCH THE KEYS FOR THE CRYPTOGRAPHIC AUTHENTICATION
			gentoo_key_f
			# GET LATEST STAGE3 TARBALL, .DIGEST && .DIGEST.asc
			get_latest_f
			# VERIFY THE AUTHENTICATION OF THE DOWNLOADED FILES
			verify_download_f
	fi
fi
}

print_inf_f() {
case $1 in
	1)
		echo -e "[\e[32m*\e[0m] \e[34mDone\e[0m";;
	2)
		echo -e "[\e[31m*\e[0m] \e[31mFAILED\e[0m";;
	3)
		clear
		echo -e "[\e[31mFATAL\e[0m]"
		echo -e "\e[31mIf this message is printed while using the Maim Menu\e[0m"
		echo -e "\e[31mThat means essential files are altered or something bad is happening.\e[0m"
		echo
		echo -e "\e[31mPlease run a health-check from the ~Main Menu~ and a Version check first.\e[0m"
		echo -e "\e[31mIf you see this again after the health/version check, please submit a bug report\e[0m"
		echo -e "\e[31mand stop using the program, or data loss may occur.\e[0m"
		echo
		echo -e "\e[31mExiting...\e[0m"
		sleep 5
		exit 1;;
	4)
		echo -e "[\e[31m*\e[0m] [\e[31mERROR\e[0m: Wrong parameters"
		exit 1;;
	5)
		echo -e "[\e[31m*\e[0m] Failed getting version";;
	6)
		echo -e "[\e[31m*\e[0m] FATAL";;
esac
}

umnt_l_f() {
	[[ -n "$(grep "dist.d/workdir-"$2 "/proc/mounts" | awk -F ' ' '{ print $2 }')" ]] \
	&& while true; do
		while read -r i; do
			umount -l "$i"/* >/dev/null 2>&1 >/dev/null 2>&1
			umount -l "$i" >/dev/null 2>&1 >/dev/null 2>&1
		done < <(grep 'dist.d/workdir-' "/proc/mounts" | awk -F ' ' '{ print $2 }')
		
		[[ -z $(grep "dist.d/workdir-"$2 "/proc/mounts" | awk -F ' ' '{ print $2 }') ]] \
		&& break
	done
}

mount_dev_sys_f() {
	[[ -z "$@" ]] && print_inf_f 3 && exit 1
	mount --rbind /dev "$1/$2" \
	&& mount --make-rslave "$1/$2" \
	&& echo -e "[\e[32m*\e[0m] Mounting $2" \
	|| { echo -e "[\e[31*\e[0m] Mounting $2"; return 1; }
}

mount_proc_f() {
	[[ -z "$@" ]] && print_inf_f 3 && exit 1
	mount -t proc /proc "$1/proc" \
	&& echo -e "[\e[32m*\e[0m] Mounting proc" \
	|| { echo -e "[\e[31m*\e[0m] Mounting proc"; return 1; }
}

pr_chroot_f() {
	[[ -z "$@" ]] && print_inf_f 3 && exit 1

	cp -L /etc/resolv.conf "$1/etc/" || exit 1

	if [[ -n $(echo "$@" | grep 'catalyst') ]]; then
		# CHECK IF PSEUDOS ARE MOUNTED
		if [[ -n $(cat /proc/mounts | grep 'dist.d/workdir-catalyst' | awk -F ' ' '{ print $1 }') ]]; then
			echo -e "\e[31mPseudos possibly mounted at target directory\e[0m"
			echo -e "\e[33mResolving the issue...\e[0m"
			umnt_l_f "catalyst"
		fi
		echo -e "\e[34mMounting pseudo\e[0m"
		[[ -z $(grep 'dist.d/workdir-catalyst' /proc/mounts | awk -F ' ' '{ print $1 }') ]] \
		&& mount_proc_f "$1"
	elif [[ -n $(echo "$@" | grep 'precomp') ]]; then
		if [[ -n $(cat /proc/mounts | grep 'dist.d/workdir-precomp' | awk -F ' ' '{ print $1 }') ]]; then
			echo -e "\e[31mPseudos possibly mounted at target directory\e[0m"
			echo -e "\e[33mResolving the issue...\e[0m"
			umnt_l_f "precomp"
		fi
		echo -e "\e[34mMounting pseudo\e[0m"
		[[ -z $(grep 'dist.d/workdir-precomp' /proc/mounts | awk -F ' ' '{ print $1 }') ]] \
		&& mount_proc_f "$1"
	fi \
	&& mount_dev_sys_f "$1" "dev" \
	&& mount_dev_sys_f "$1" "sys" \
	|| { echo -e "[\e[31m*\e[0m] Something went wrong" && exit 1; }

	mkdir -p "$1/sinit.d"

	[[ ! -e "$1/sinit.d/chsinprog" ]] && rsync -aAXr "${CWORKDIR}/scripts/chroot_scripts/" "$1/sinit.d/" >/dev/null 2>&1 \
	|| rsync -aAXr --exclude="chsinprog" "${CWORKDIR}/scripts/chroot_scripts/" "$1/sinit.d/" >/dev/null 2>&1 \
	&& rsync -aAXr "${CCONFDIR}/system/portage/" "$1/sinit.d/" >/dev/null 2>&1 \
	&& rsync -aAXr --exclude="portage" "${CCONFDIR}/system/" "$1/sinit.d/" >/dev/null 2>&1 \
	&& echo -e "[\e[32m*\e[0m] Copying \e[34mbuilder's\e[0m files to new system" \
	|| { echo -e "[\e[31m*\e[0m] Copying \e[34mbuilder's\e[0m files to new system"; return 1; }

	# CREATE REPOS.CONF DIRECOTRY & AND COPY REPOS.CONF TO IT
	mkdir -p "$1/etc/portage/repos.conf"
	cp "$1/usr/share/portage/config/repos.conf" "$1/etc/portage/repos.conf/gentoo.conf"

	# Set local timezone if set
	if [[ -n $(cat /etc/timezone) ]]; then
		TIMEZONE=$(cat /etc/timezone)
		sed -i -e "s_TMZ_${TIMEZONE}_g" "$1/sinit.d/chinit.conf"
		unset TIMEZONE
	fi

	echo -e "[\e[32m*\e[0m] Copying requested files"
	if [[ -n $(cat ${CCONFDIR}/system/inject_files | sed '/^#/ d' | sed '/^\s*$/d') ]]; then

		while read -r INJFL;do
			f1="$(echo $INJFL | awk -F ' ' '{ print $1 }')"
			f2="${BWORKDIR}/(echo $INJFL | awk -F ' ' '{ print $2 }')"
			echo "Copying $f1 to $f2"
			rsync -aAXPhrv "$f1" "$f2" >/dev/null 2>&1 \
			&& print_inf 1 || { print_inf 2 mapfile -t INJFLERR < <($INJFL | awk -F ' ' '{ print $1 }'); }
		done < <(cat "${CCONFDIR}/system/inject_files" | sed '/^#/ d' | sed '/^\s*$/d')
		unset INJFL

		if [[ -n "${INJFLERR}" ]]; then
			echo "Failed to copy the following packages: "
			echo "${INJFLERR[@]}"
			while true; do
				echo "You can list the failed files again, continue, request terminal or exit"
				read -rp "Please choose: LIST/CONTINUE/TERMINAL/EXIT" INJFLANS
				case "$INJFLANS" in
					LIST)
						clear; echo "${INJFLERR[@]}";;
					CONTINUE)
						while true; do
							read -p "Are you sure? Y/N " YN
							case $YN in
								[yY])
									echo "Proceeding"
									INJFLESC=0
									break;;
								[nN])
									INJFLESC=1
									;;
							esac
						done;;
					TERMINAL)
						subshel_f
						INJFLESC=0;;
					EXIT)
						while true; do
							read -p "Are you sure? Y/N " YN
							case $YN in
								[yY])
									echo "Aborting..."
									exit 0;;
								[nN])
									INJFLESC=1
									break;;
							esac
						done;;
				esac
				[[ "$INJFLESC" == 0 ]] && break
			done
		fi
		unset YN
		unset INJFLESC
		unset INJFLANS
		unset INJFLERR
	else
		echo -e "[\e[32m*\e[0m] List empty"
	fi

	echo -e "\e[34mChrooting at new system\e[0m"
	sleep 2
	chroot "$1" "sinit.d/chroot_init" "$@" || { echo -e "[\e[31m*\e[0m] Chrooting at new system"; return 1; } \
	&& sinit_mon_f "PARTB"
}

lcreq_f() {
	# THIS SCRIPT IS SOURCED AT THE BEGINING FOR CHECKING THE BUILDER'S RUNTIME DEPENDENCIES
	CRDPENDS=''
	amiroot_sub_f() {
	if [[ "$1" == "0" ]]; then
			return 0
	else
		return 1
	fi
}

case "$1" in
	1)
		[[ $(command -v eix) ]] \
		|| { echo -e "[\e[33m*\e[0m] \e[35mPlease install eix to proceed!\e[0m" \
		&& { amiroot $UID && echo -e "[\e[32m*\e[0m] Root privileges found" \
		&& emerge -aq eix && echo -e "[\e[33m*\e[0m] \e[35mUpdating database\e[0m" \
		&& eix-sync -a >/dev/null 2>&1; } \
		|| { echo -e "[\e[31m*\e[0m] Could not get root privileges" \
		&& echo "Please resolve this issue and start again" && exit 1; }; }

		mapfile -t lreq < <(cat "${CLOCALLG}/loc_req" | sed '/^#/ d' | sed '/^\s*$/d')

		for i in "${lreq[@]}"; do
			sleep 0.1
			if eix --installed "$i" >/dev/null 2>&1; then
				echo -e "[\e[32m*\e[0m] Searching for \e[32m$i\e[0m"
			else
				echo -e "[\e[31m*\e[0m] Searching for $i"
				echo -e "[\e[33m*\e[0m] Attempting to resolve the missing dependency"
				amiroot $UID && echo -e "[\e[32m*\e[0m] Root privileges found" \
				&& emerge -aq "$i" \
				|| { echo -e "[\e[31m*\e[0m] Could not get root privileges" \
				&& echo "Please resolve this issue and start again" && exit 1; }
			fi
		done;;
	2)
		mapfile -t lreq < <(cat "${CLOCALLG}/nogloc_req" | sed '/^#/ d' | sed '/^\s*$/d')

		for i in "${lreq[@]}"; do
			sleep 0.1
			if command -v "$i" >/dev/null 2>&1; then
				echo -e "[\e[32m*\e[0m] Searching for \e[32m$i\e[0m"
			else
				echo -e "[\e[31m*\e[0m] Searching for $i"
				CRDPENDS=1
			fi
		done
		[[ "${CRDPENDS}" == 1 ]] && while true; do
		echo -e "\e[33mIf you think some of those dependencies are name missmatch or not important\e[0m"
		echo -e "\e[33mYou can choose to continue at your own ristk\e[0m"
		read -rp "Continue? Y/N: " ANS
		case "${ANS}" in
			[yY])
				break;;
			[nN])
				echo "Exiting..." && sleep 1 && exit 1;;
		esac
	done
esac
}